<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Rapport de Chantier</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.294.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { margin: 0; padding: 0; background-color: #f8fafc; overflow-x: hidden; }

        /* --- RÉGLAGES IMPRESSION --- */
        @media print {
            body { background: white !important; }
            #root > div:not(.modal-root) { display: none !important; }
            header, nav, .no-print { display: none !important; }
            
            .modal-root {
                position: absolute !important;
                inset: 0 !important;
                width: 100% !important;
                background: white !important;
                display: block !important;
                visibility: visible !important;
            }
            .modal-root * { visibility: visible !important; }

            @page { size: A4 portrait; margin: 1cm; }
            .text-black-force { color: black !important; }
            .border-black-force { border-color: black !important; }
        }
    </style>
</head>
<body>
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import ReactDOM from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
        import { getFirestore, collection, addDoc, updateDoc, serverTimestamp, onSnapshot, deleteDoc, doc } from 'firebase/firestore';
        import { Calendar, User, Clock, Package, MapPin, Camera, CheckCircle2, Plus, Minus, Trash2, ChevronRight, Loader2, LayoutDashboard, Search, Tag, Users, Printer, X, AlertTriangle, FileBarChart, Wallet, Calculator, Coins, Edit, Image as ImageIcon } from 'lucide-react';

        // --- 1. CONFIGURATION LOGO ---
        const LOGO_URL = "https://cdn-icons-png.flaticon.com/512/1048/1048950.png"; 

        // --- 2. CONFIGURATION FIREBASE ---
        const firebaseConfig = {
  apiKey: "AIzaSyBxmAa40ba2Kk0g2ToI-FZHY22dK36aK-A",
  authDomain: "rapport-chantier.firebaseapp.com",
  projectId: "rapport-chantier",
  storageBucket: "rapport-chantier.firebasestorage.app",
  messagingSenderId: "83294748865",
  appId: "1:83294748865:web:94688273be6fdc43585440",
  measurementId: "G-MKQZ4VBGMB"
};

        let app, auth, db;
        const isDemoMode = !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("TA_CLE");
        if (!isDemoMode) {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) { console.error("Erreur Firebase:", e); }
        }
        const appId = 'mon-chantier-app'; 

        const HOURLY_RATES = { 'Sanitaire': 125, 'Peinture': 90, 'Nettoyage': 65, 'Autre': 85 };
        const TRAVEL_FEES = {
            'Zone 1': { fee: 60, label: '0 - 5 km' },
            'Zone 2': { fee: 90, label: '5 - 30 km' },
            'Zone 3': { fee: 120, label: '+ 30 km' }
        };
        const TECHNICIANS = ["André", "Diogo", "Magda", "Mario"];
        const MARGIN_MULTIPLIER = 1.20;
        
        const VAUD = { 
            PAT_AVS: 0.053, PAT_AC: 0.011, PAT_AF: 0.0295, PAT_ADM: 0.0015, PAT_LAA: 0.025, 
            EMP_AVS: 0.053, EMP_AC: 0.011, EMP_LAA: 0.0145
        };

        const getLPPRate = (age) => {
            if (age < 25) return 0.005; if (age < 35) return 0.07; if (age < 45) return 0.10; if (age < 55) return 0.15; return 0.18;
        };

        const formatMoney = (val) => Number(val || 0).toFixed(2);
        const formatDate = (dateString) => {
            try { return dateString ? new Date(dateString).toLocaleDateString('fr-CH') : '-'; } 
            catch (e) { return '-'; }
        };

        const getTaskStyles = (task) => {
            switch(task) {
                case 'Peinture': return { bg: 'bg-orange-100', text: 'text-orange-500', badge: 'bg-orange-100 text-orange-700' };
                case 'Nettoyage': return { bg: 'bg-emerald-100', text: 'text-emerald-500', badge: 'bg-emerald-100 text-emerald-700' };
                case 'Autre': return { bg: 'bg-slate-200', text: 'text-slate-500', badge: 'bg-slate-200 text-slate-700' };
                default: return { bg: 'bg-blue-100', text: 'text-blue-500', badge: 'bg-blue-100 text-blue-700' };
            }
        };

        // --- COMPOSANT FACTURE CLIENT ---
        const InvoiceModal = ({ report, onClose }) => {
            if (!report) return null;
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[110] flex items-center justify-center p-4 modal-root">
                    <div className="bg-white w-full max-w-2xl rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh] text-left modal-content">
                        <div className="p-6 border-b flex justify-between items-center bg-gray-50 no-print">
                            <h2 className="font-black text-xl text-gray-800 uppercase text-center flex-1 ml-8">Facture Client</h2>
                            <button onClick={onClose} className="p-2 bg-white rounded-full shadow-sm hover:bg-gray-100"><X size={20}/></button>
                        </div>
                        <div className="p-10 overflow-y-auto bg-white flex-1 text-gray-800 text-left print:p-0">
                            <div className="flex justify-between mb-12 items-start">
                                <div className="w-1/2">
                                    <img src={LOGO_URL} className="h-24 object-contain mb-4" alt="Logo" />
                                    <div className="text-sm text-black-force">
                                        <p className="font-bold uppercase">Votre Entreprise</p>
                                        <p>1000 Lausanne, Vaud</p>
                                    </div>
                                </div>
                                <div className="text-right w-1/2">
                                    <h1 className="text-3xl font-black mb-2 text-black-force">FACTURE</h1>
                                    <p className="font-bold text-gray-500 text-black-force uppercase">REF: {(report.id || '').substring(0,6).toUpperCase()}</p>
                                    <p className="text-gray-500 text-black-force">Date: {formatDate(report.date)}</p>
                                    <div className="mt-6 border p-4 text-left rounded bg-gray-50 print:bg-white print:border-black border-black-force">
                                        <p className="text-[10px] font-bold text-gray-400 uppercase text-black-force">Client :</p>
                                        <p className="text-xl font-bold text-black-force">{report.clientName}</p>
                                    </div>
                                </div>
                            </div>
                            <table className="w-full mb-10 text-sm">
                                <thead>
                                    <tr className="border-b-2 border-black font-bold uppercase text-xs text-left text-black-force">
                                        <th className="py-2 w-3/5">Description des prestations</th>
                                        <th className="py-2 text-center">Qté</th>
                                        <th className="py-2 text-right">Total HT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr className="border-b border-gray-100 border-black-force">
                                        <td className="py-4">
                                            <span className="font-bold block text-black-force">{report.taskType} — <span className="font-normal text-gray-500 text-black-force">Technicien: {report.technician}</span></span>
                                        </td>
                                        <td className="py-4 text-center text-black-force">{report.hours} h</td>
                                        <td className="py-4 text-right font-bold text-black-force whitespace-nowrap">{formatMoney(report.laborTotal)}.-</td>
                                    </tr>
                                    {report.materialsCost > 0 && (
                                        <tr className="border-b border-gray-100 border-black-force">
                                            <td className="py-4 font-bold text-black-force">Fournitures : <span className="font-normal text-gray-500 text-black-force italic text-xs">{report.materialsList}</span></td>
                                            <td className="py-4 text-center text-black-force">1</td>
                                            <td className="py-4 text-right font-bold text-black-force whitespace-nowrap">{formatMoney(report.materialsCost * MARGIN_MULTIPLIER)}.-</td>
                                        </tr>
                                    )}
                                    <tr className="border-black-force">
                                        <td className="py-4 font-bold text-black-force">Frais de déplacement ({report.zone})</td>
                                        <td className="py-4 text-center text-black-force">1</td>
                                        <td className="py-4 text-right font-bold text-black-force whitespace-nowrap">{formatMoney(report.travelFee)}.-</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div className="flex justify-end pt-6 border-t-2 border-black border-black-force">
                                <div className="w-full sm:w-1/2 text-right text-black-force">
                                    <div className="flex justify-between py-1"><span>Total HT</span><span className="font-bold">{formatMoney(report.grandTotal)} CHF</span></div>
                                    <div className="flex justify-between py-1"><span>TVA (8.1%)</span><span className="font-bold">{formatMoney(report.grandTotal * 0.081)} CHF</span></div>
                                    <div className="flex justify-between py-2 mt-2 text-xl font-black border-t border-black border-black-force"><span>TOTAL TTC</span><span>{formatMoney(report.grandTotal * 1.081)} CHF</span></div>
                                </div>
                            </div>
                        </div>
                        <div className="p-6 border-t bg-gray-50 no-print">
                            <button onClick={() => window.print()} className="w-full bg-blue-900 text-white font-black py-4 rounded-xl flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg hover:bg-blue-800"><Printer size={20}/> Imprimer Facture Client</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('form'); 
            const [submitted, setSubmitted] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [reports, setReports] = useState([]);
            const [selectedReport, setSelectedReport] = useState(null);
            const [isSummaryOpen, setIsSummaryOpen] = useState(false);
            const [reportToDelete, setReportToDelete] = useState(null);
            const [editingId, setEditingId] = useState(null);
            
            const [salaryEmployee, setSalaryEmployee] = useState(TECHNICIANS[0]);
            const [netSalary, setNetSalary] = useState(0);
            const [employeeAge, setEmployeeAge] = useState(30);

            const [formData, setFormData] = useState({ date: new Date().toISOString().split('T')[0], clientName: '', technician: 'André', taskType: 'Sanitaire', hours: 0, materialsList: '', materialsCost: 0, zone: 'Zone 1' });

            useEffect(() => {
                const init = async () => {
                    if(!isDemoMode && auth) {
                        try { await signInAnonymously(auth); } catch(e){}
                        onAuthStateChanged(auth, setUser);
                    } else {
                        const saved = localStorage.getItem('demo_reports');
                        if(saved) setReports(JSON.parse(saved));
                    }
                };
                init();
            }, []);

            useEffect(() => {
                if (isDemoMode || !user || !db) return;
                const reportsRef = collection(db, 'artifacts', appId, 'public', 'data', 'reports');
                return onSnapshot(reportsRef, (snapshot) => {
                    const docs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setReports(docs.sort((a, b) => new Date(b.date) - new Date(a.date)));
                });
            }, [user]);

            const currentRate = HOURLY_RATES[formData.taskType] || 85;
            const laborTotal = formData.hours * currentRate;
            const materialsTotal = formData.materialsCost * MARGIN_MULTIPLIER;
            const travelFee = TRAVEL_FEES[formData.zone]?.fee || 0;
            const grandTotal = laborTotal + materialsTotal + travelFee;

            const lppRateVal = getLPPRate(employeeAge);
            const lppShare = lppRateVal / 2;
            const empChargesRate = VAUD.EMP_AVS + VAUD.EMP_AC + VAUD.EMP_LAA + lppShare;
            const estGross = netSalary > 0 ? netSalary / (1 - empChargesRate) : 0;
            const totalCost = estGross * (1 + (VAUD.PAT_AVS + VAUD.PAT_AC + VAUD.PAT_AF + VAUD.PAT_ADM + VAUD.PAT_LAA + lppShare));

            const adjustHours = (amount) => setFormData(p => ({ ...p, hours: Math.max(0, p.hours + amount) }));
            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.name === 'hours' || e.target.name === 'materialsCost' ? parseFloat(e.target.value) || 0 : e.target.value }));
            
            const deleteReport = async (id) => {
                if (isDemoMode) {
                    const filtered = reports.filter(r => r.id !== id);
                    setReports(filtered);
                    localStorage.setItem('demo_reports', JSON.stringify(filtered));
                } else {
                    try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', id)); } catch (e) {}
                }
                setReportToDelete(null);
            };

            const handleEdit = (report) => {
                setEditingId(report.id);
                setFormData({
                    date: report.date, clientName: report.clientName, technician: report.technician, taskType: report.taskType,
                    hours: report.hours, materialsList: report.materialsList || '', materialsCost: report.materialsCost || 0, zone: report.zone || 'Zone 1'
                });
                setView('form');
            };

            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                if (!formData.clientName || formData.hours <= 0) return alert("Nom du client et heures requis."); 
                setIsSaving(true); 
                const data = { ...formData, hourlyRate: currentRate, travelFee, laborTotal, materialsTotal, grandTotal, updatedAt: new Date().toISOString() };
                if (isDemoMode) {
                    let updated = editingId ? reports.map(r => r.id === editingId ? { ...data, id: editingId } : r) : [{ ...data, id: 'REF-' + Date.now().toString().slice(-6), createdAt: new Date().toISOString() }, ...reports];
                    setReports(updated);
                    localStorage.setItem('demo_reports', JSON.stringify(updated));
                } else {
                    try { 
                        if (editingId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'reports', editingId), data);
                        else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'reports'), { ...data, createdAt: serverTimestamp(), userId: user?.uid }); 
                    } catch (err) { alert(err.message); }
                }
                setIsSaving(false); setEditingId(null); setSubmitted(true);
                setFormData({ date: new Date().toISOString().split('T')[0], clientName: '', technician: 'André', taskType: 'Sanitaire', hours: 0, materialsList: '', materialsCost: 0, zone: 'Zone 1' });
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans antialiased text-gray-900 text-left pb-32">
                
                <header className="bg-blue-600 p-8 rounded-b-[3rem] shadow-xl text-white mb-6 relative overflow-hidden no-print">
                    <div className="flex justify-between items-center relative z-10">
                        <div><h1 className="text-2xl font-black tracking-tight uppercase">{editingId ? 'Modification' : (view === 'form' ? 'Nouveau Rapport' : view === 'dashboard' ? 'Historique' : 'Salaire')}</h1><p className="text-blue-100 text-[9px] font-bold uppercase tracking-[0.2em] opacity-80 mt-1">Canton de Vaud</p></div>
                        <img src={LOGO_URL} className="w-16 h-16 object-contain" alt="Logo" />
                    </div>
                    <div className="absolute -right-20 -top-20 w-64 h-64 bg-white/10 rounded-full blur-[100px]"></div>
                </header>

                <main className="max-w-xl mx-auto px-4 no-print">
                    {submitted ? (
                        <div className="text-center py-20 px-6 animate-in zoom-in">
                            <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-8 border-4 border-white shadow-xl text-green-600"><CheckCircle2 size={48} /></div>
                            <h2 className="text-2xl font-black mb-6 uppercase">Opération Réussie</h2>
                            <button onClick={() => {setSubmitted(false); setView('form');}} className="w-full bg-blue-600 text-white font-black py-5 rounded-[2rem] shadow-2xl text-lg uppercase active:scale-95 transition-all">Retour</button>
                        </div>
                    ) : view === 'salary' ? (
                        <div className="space-y-4 animate-in fade-in">
                            <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 text-center flex flex-col items-center">
                                <h3 className="text-gray-400 text-[10px] font-black uppercase mb-6 flex items-center justify-center gap-2"><User size={12} className="text-blue-500" /> Profil Employé</h3>
                                <div className="grid grid-cols-2 gap-3 mb-6 w-full max-w-[300px]">
                                    {TECHNICIANS.map(tech => (<button key={tech} onClick={()=>setSalaryEmployee(tech)} className={`py-3 rounded-xl text-xs font-bold border transition-all ${salaryEmployee === tech ? 'bg-blue-600 border-blue-600 text-white shadow-lg' : 'bg-gray-50 border-gray-100 text-gray-400 hover:bg-gray-100'}`}>{tech}</button>))}
                                </div>
                                <div className="w-full">
                                    <label className="text-[10px] font-black text-gray-400 uppercase block mb-3 text-center">Âge de l'employé</label>
                                    <div className="bg-gray-50 rounded-2xl p-4 flex items-center justify-center gap-8 w-full max-w-[280px] mx-auto border border-gray-100 shadow-inner">
                                        <button onClick={()=>setEmployeeAge(Math.max(18, employeeAge-1))} className="w-12 h-12 bg-white rounded-full shadow-sm text-blue-600 flex items-center justify-center active:scale-90 transition-all border border-blue-50 hover:bg-blue-50"><Minus size={20} strokeWidth={3}/></button>
                                        <span className="text-2xl font-black text-gray-800 tabular-nums">{employeeAge} ans</span>
                                        <button onClick={()=>setEmployeeAge(Math.min(65, employeeAge+1))} className="w-12 h-12 bg-white rounded-full shadow-sm text-blue-600 flex items-center justify-center active:scale-90 transition-all border border-blue-50 hover:bg-blue-50"><Plus size={20} strokeWidth={3}/></button>
                                    </div>
                                </div>
                            </div>
                            <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 flex flex-col items-center">
                                <h3 className="text-gray-400 text-[10px] font-black uppercase mb-6 flex items-center justify-center gap-2"><Wallet size={12} className="text-blue-500" /> Salaire Net Versé (CHF)</h3>
                                <input type="number" value={netSalary || ''} onChange={(e) => setNetSalary(parseFloat(e.target.value) || 0)} className="w-full max-w-[220px] h-16 bg-gray-50 rounded-2xl font-bold text-gray-800 text-center text-2xl outline-none border-2 border-transparent focus:border-blue-500 transition-all" placeholder="0.00" />
                            </div>
                            <div className="bg-white rounded-[2rem] p-8 shadow-sm border border-gray-100">
                                <h3 className="text-gray-400 text-[10px] font-black uppercase mb-6 flex items-center gap-2"><Calculator size={12} className="text-blue-500" /> Détail Coût Entreprise (Vaud)</h3>
                                <div className="space-y-4 text-sm">
                                    <div className="flex justify-between items-center pb-3 border-b border-gray-50"><span className="font-bold text-gray-500 uppercase tracking-tight">Salaire BRUT estimé</span><span className="font-black text-gray-800 text-lg">{formatMoney(estGross)} .-</span></div>
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center"><span className="text-gray-500">AVS / AI / APG</span><span className="font-bold">{formatMoney(estGross * VAUD.PAT_AVS)} .-</span></div>
                                        <div className="flex justify-between items-center"><span className="text-gray-500">Assurance Chômage AC</span><span className="font-bold">{formatMoney(estGross * VAUD.PAT_AC)} .-</span></div>
                                        <div className="flex justify-between items-center"><span className="text-gray-500">Allocations Familiales AF</span><span className="font-bold">{formatMoney(estGross * VAUD.PAT_AF)} .-</span></div>
                                        <div className="flex justify-between items-center"><span className="text-gray-500">LPP (Prévoyance)</span><span className="font-bold">{formatMoney(estGross * lppShare)} .-</span></div>
                                        <div className="flex justify-between items-center"><span className="text-gray-500">Assurance Accidents LAA</span><span className="font-bold">{formatMoney(estGross * VAUD.PAT_LAA)} .-</span></div>
                                    </div>
                                    <div className="pt-4"><div className="bg-blue-600 text-white p-6 rounded-[2rem] shadow-xl text-right"><p className="text-[10px] uppercase opacity-60 font-black mb-1">Total déboursé</p><p className="text-3xl font-black tabular-nums">{formatMoney(totalCost)} .-</p></div></div>
                                </div>
                            </div>
                        </div>
                    ) : view === 'form' ? (
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 text-center flex flex-col items-center">
                                <h3 className="text-gray-400 text-[10px] font-black uppercase mb-6 flex items-center justify-center gap-2"><User size={12} className="text-blue-500" /> Identification</h3>
                                <div className="grid grid-cols-2 gap-3 mb-8 w-full max-w-[300px]">
                                    {TECHNICIANS.map(tech => (<button key={tech} type="button" onClick={() => setFormData(p => ({...p, technician: tech}))} className={`py-3 rounded-xl text-xs font-bold border transition-all ${formData.technician === tech ? 'bg-blue-600 border-blue-600 text-white shadow-lg' : 'bg-gray-50 border-gray-100 text-gray-400 hover:bg-gray-100'}`}>{tech}</button>))}
                                </div>
                                <div className="w-full px-2 space-y-4 text-center">
                                    <div className="space-y-1"><label className="text-[10px] font-bold text-gray-400 uppercase block text-left ml-2">Date du rapport</label><input type="date" name="date" value={formData.date} onChange={handleInputChange} className="w-full bg-gray-50 rounded-2xl h-14 font-bold text-gray-800 text-center outline-none border-2 border-transparent focus:border-blue-500 transition-all" /></div>
                                    <div className="space-y-1"><label className="text-[10px] font-bold text-gray-400 uppercase block text-left ml-2">Nom du Client</label><input type="text" name="clientName" placeholder="Mme Dupont" value={formData.clientName} onChange={handleInputChange} className="w-full bg-gray-50 rounded-2xl h-14 font-bold text-gray-800 text-center outline-none border-2 border-transparent focus:border-blue-500 transition-all" /></div>
                                </div>
                            </div>
                            
                            <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100">
                                <div className="flex justify-between items-center mb-6 px-1"><h3 className="text-gray-400 text-[10px] font-black uppercase flex items-center gap-2"><Clock size={12} className="text-blue-500" /> Travail</h3><span className="bg-blue-600 text-white text-[10px] font-black px-3 py-1 rounded-full shadow-md">{currentRate}.-/h</span></div>
                                <div className="space-y-6 flex flex-col items-center">
                                    <div className="bg-gray-50 rounded-2xl overflow-hidden w-full border border-gray-100"><select name="taskType" value={formData.taskType} onChange={handleInputChange} className="w-full px-4 py-4 bg-transparent border-0 font-bold text-center outline-none text-lg appearance-none">{Object.keys(HOURLY_RATES).map(t => <option key={t} value={t}>{t}</option>)}</select></div>
                                    <div className="flex items-center gap-8 p-4"><button type="button" onClick={() => adjustHours(-0.5)} className="w-14 h-14 bg-white rounded-2xl shadow-sm text-blue-600 border border-blue-100 active:scale-90 transition-all flex items-center justify-center hover:bg-blue-50"><Minus size={20}/></button><div className="text-center"><span className="text-4xl font-black text-blue-700 block tabular-nums">{formData.hours.toFixed(1)}</span><span className="text-[10px] font-black text-blue-400 uppercase">Heures</span></div><button type="button" onClick={() => adjustHours(0.5)} className="w-14 h-14 bg-blue-600 rounded-2xl shadow-md text-white active:scale-90 transition-all flex items-center justify-center hover:bg-blue-700"><Plus size={20}/></button></div>
                                </div>
                            </div>

                            <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100">
                                <h3 className="text-gray-400 text-[10px] font-black uppercase flex items-center gap-2 mb-4"><Package size={12} className="text-blue-500" /> Matériel</h3>
                                <div className="space-y-4 px-2">
                                    <textarea name="materialsList" placeholder="Détail des fournitures..." rows="2" value={formData.materialsList} onChange={handleInputChange} className="w-full px-4 py-4 bg-gray-50 border-0 rounded-2xl font-medium text-center outline-none placeholder:text-gray-300 resize-none shadow-inner" />
                                    <div className="grid grid-cols-[3.5rem_1fr_3.5rem] items-center bg-gray-50 rounded-2xl overflow-hidden border-2 border-transparent focus-within:border-blue-500 shadow-inner"><span className="text-gray-400 font-bold text-xs text-center uppercase">CHF</span><input type="number" name="materialsCost" placeholder="Prix d'achat" value={formData.materialsCost || ''} onChange={handleInputChange} className="w-full py-4 bg-transparent border-0 font-bold text-center outline-none text-lg" /><span className="text-green-600 font-black text-[9px] text-center uppercase tracking-tighter">+20%</span></div>
                                </div>
                            </div>

                            <div className="bg-white rounded-[2rem] p-6 shadow-sm border border-gray-100 text-center">
                                <h3 className="text-gray-400 text-[10px] font-black uppercase mb-4 flex justify-center items-center gap-2"><MapPin size={12} className="text-blue-500" /> Zone</h3>
                                <div className="grid grid-cols-3 gap-2 px-1">{Object.entries(TRAVEL_FEES).map(([z, data]) => (<button key={z} type="button" onClick={() => setFormData(p => ({...p, zone: z}))} className={`py-4 rounded-2xl border transition-all ${formData.zone === z ? 'bg-blue-600 border-blue-600 text-white shadow-lg scale-105' : 'bg-gray-50 border-gray-100 text-gray-400 hover:bg-gray-100'}`}><div className="text-[10px] font-black uppercase">{z}</div><div className="text-[8px] font-bold opacity-80 leading-tight uppercase">{data.label}</div><div className="text-sm font-black mt-1">{data.fee}.-</div></button>))}</div>
                            </div>

                            <div className="flex flex-col items-center justify-center py-12 px-2 w-full">
                                <div className="w-full bg-blue-900 text-white p-6 rounded-[2.5rem] shadow-2xl flex justify-between items-center border border-white/10 max-w-full">
                                    <div className="flex flex-col text-left">
                                        <span className="text-[10px] opacity-60 font-black uppercase tracking-tighter">Total Facture HT</span>
                                        <span className="text-3xl font-black tabular-nums">{formatMoney(grandTotal)} .-</span>
                                    </div>
                                    <button type="submit" disabled={isSaving} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-4 rounded-[1.5rem] font-black text-sm flex items-center gap-2 shadow-xl active:scale-95 transition-all uppercase">
                                        {isSaving ? <Loader2 className="animate-spin" size={18} /> : (editingId ? 'Modifier' : <>VALIDER <ChevronRight size={18} /></>)}
                                    </button>
                                </div>
                            </div>
                        </form>
                    ) : (
                    <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 text-center no-print">
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col items-center justify-center"><p className="text-gray-400 text-[10px] font-black uppercase mb-1">CA Total</p><p className="text-2xl font-black text-blue-600 tabular-nums">{formatMoney(reports.reduce((a,c) => a+(c.grandTotal||0),0))} .-</p></div>
                            <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 flex flex-col items-center justify-center"><p className="text-gray-400 text-[10px] font-black uppercase mb-1">Missions</p><p className="text-2xl font-black text-gray-800 tabular-nums">{reports.length}</p></div>
                        </div>
                        <div className="space-y-4 px-1">
                            {reports && reports.length > 0 ? reports.map((r) => {
                                const stl = getTaskStyles(r.taskType);
                                return (
                                    <div key={r.id || Math.random()} className="bg-white p-5 rounded-[2.5rem] shadow-sm flex items-center gap-4 border border-transparent transition-all hover:border-blue-100 overflow-hidden">
                                        {/* GAUCHE : ICONE TACHE */}
                                        <div onClick={() => setSelectedReport(r)} className={`w-14 h-14 rounded-2xl flex items-center justify-center shadow-sm shrink-0 cursor-pointer ${stl.bg} ${stl.text}`}>
                                            <Tag size={24} />
                                        </div>
                                        
                                        {/* MILIEU GAUCHE : CLIENT & TECH (ALIGNE A GAUCHE) */}
                                        <div onClick={() => setSelectedReport(r)} className="flex-1 min-w-0 text-left cursor-pointer">
                                            <h4 className="font-black text-gray-800 text-lg uppercase truncate leading-tight">{r.clientName || 'Inconnu'}</h4>
                                            <div className="flex items-center gap-2 mt-1 flex-wrap">
                                                <span className="text-[9px] bg-slate-100 text-slate-500 font-black px-2 py-0.5 rounded uppercase">{r.technician}</span>
                                                <span className={`text-[9px] font-black px-2 py-0.5 rounded uppercase ${stl.badge}`}>{r.taskType}</span>
                                            </div>
                                        </div>

                                        {/* MILIEU DROITE : PRIX & DATE (ALIGNE A DROITE DANS COLONNE FIXE ASSEZ LARGE) */}
                                        <div onClick={() => setSelectedReport(r)} className="text-right shrink-0 pr-4 border-r border-gray-100 w-32 cursor-pointer flex flex-col justify-center">
                                            <p className="font-black text-blue-600 text-lg tabular-nums leading-none mb-1 whitespace-nowrap">{formatMoney(r.grandTotal)} .-</p>
                                            <p className="text-[9px] text-gray-400 font-black uppercase tracking-tighter leading-none">{formatDate(r.date)}</p>
                                        </div>

                                        {/* DROITE : ACTIONS VERTICALES (COLONNE FIXE POUR ALIGNEMENT PARFAIT) */}
                                        <div className="flex flex-col gap-2 shrink-0 w-10 items-center justify-center">
                                            <button onClick={() => handleEdit(r)} title="Modifier" className="p-2 bg-blue-50 text-blue-500 rounded-lg hover:bg-blue-600 hover:text-white transition-all active:scale-90 shadow-sm"><Edit size={14} /></button>
                                            <button onClick={() => setReportToDelete(r.id)} title="Supprimer" className="p-2 bg-red-50 text-red-500 rounded-lg hover:bg-red-600 hover:text-white transition-all active:scale-90 shadow-sm"><Trash2 size={14} /></button>
                                        </div>
                                    </div>
                                );
                            }) : (
                                <div className="py-12 bg-white rounded-[2.5rem] border border-dashed border-gray-200 text-gray-400 font-bold italic">Aucun rapport enregistré</div>
                            )}
                        </div>
                        <button onClick={() => setIsSummaryOpen(true)} className="w-full bg-blue-900 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 shadow-xl active:scale-95 hover:bg-blue-800 transition-all"><FileBarChart size={20}/> Historique Comptable</button>
                    </div>
                    )}
                </main>

                {/* MODALES */}
                {selectedReport && <InvoiceModal report={selectedReport} onClose={() => setSelectedReport(null)} />}
                
                {isSummaryOpen && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[120] flex items-center justify-center p-4 modal-root">
                        <div className="bg-white w-full max-w-4xl rounded-[2.5rem] overflow-hidden shadow-2xl flex flex-col max-h-[90vh] modal-content">
                            <div className="p-6 border-b flex justify-between items-center bg-gray-50 no-print">
                                <h2 className="font-black text-xl text-gray-800 uppercase text-center flex-1 ml-8 text-black-force">Rapport Fiduciaire</h2>
                                <button onClick={() => setIsSummaryOpen(false)} className="p-2 bg-white rounded-full shadow-sm hover:bg-gray-100 transition-all"><X size={20}/></button>
                            </div>
                            <div className="p-8 overflow-y-auto bg-white flex-1 text-gray-800 text-left print:p-10">
                                <table className="w-full text-left text-sm border-collapse">
                                    <thead><tr className="border-b-2 border-black font-black uppercase text-gray-400 text-black-force"><th className="py-3 px-2">Date</th><th className="py-3 px-2 text-center">Client</th><th className="py-3 px-2 text-right">Total HT</th></tr></thead>
                                    <tbody>{reports.map((r, i) => (<tr key={i} className="border-b border-gray-50 border-black-force text-black-force"><td className="py-3 px-2">{formatDate(r.date)}</td><td className="py-3 px-2 text-center uppercase font-bold">{r.clientName}</td><td className="py-3 px-2 text-right font-black tabular-nums whitespace-nowrap">{formatMoney(r.grandTotal)} .-</td></tr>))}</tbody>
                                </table>
                                <div className="flex justify-end mt-12"><div className="w-64 bg-blue-900 text-white p-6 rounded-3xl text-right shadow-xl print:bg-white print:text-black print:border print:border-black"><p className="text-[10px] uppercase opacity-60 font-black mb-1 print:text-black">Cumul CA HT</p><p className="text-2xl font-black tabular-nums">{formatMoney(reports.reduce((a,c) => a+(c.grandTotal||0),0))} .-</p></div></div>
                            </div>
                            <div className="p-6 border-t bg-gray-50 no-print"><button onClick={() => window.print()} className="w-full bg-blue-600 text-white font-black py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 transition-all shadow-lg hover:bg-blue-700"><Printer size={20}/> Imprimer Rapport</button></div>
                        </div>
                    </div>
                )}

                {reportToDelete && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] flex items-center justify-center p-6 animate-in fade-in">
                        <div className="bg-white w-full max-w-sm rounded-[2.5rem] p-8 text-center shadow-2xl">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 text-red-600"><AlertTriangle size={32} /></div>
                            <h3 className="text-xl font-black text-gray-800 mb-2 uppercase text-center">Supprimer ?</h3>
                            <p className="text-gray-500 mb-8 text-sm text-center">Cette action est irréversible.</p>
                            <div className="flex gap-4">
                                <button onClick={() => setReportToDelete(null)} className="flex-1 bg-gray-100 text-gray-500 font-black py-4 rounded-2xl uppercase hover:bg-gray-200 active:scale-95 transition-all">Non</button>
                                <button onClick={() => deleteReport(reportToDelete)} className="flex-1 bg-red-600 text-white font-black py-4 rounded-2xl shadow-lg uppercase active:scale-95 hover:bg-red-700 transition-all">Effacer</button>
                            </div>
                        </div>
                    </div>
                )}

                <nav className="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-2xl border-t border-gray-100 p-5 flex justify-around items-center z-50 shadow-2xl rounded-t-[2.5rem] no-print">
                    <button onClick={() => {setView('form'); setSubmitted(false); setEditingId(null)}} className={`flex flex-col items-center gap-1.5 py-2 px-6 rounded-2xl transition-all ${view === 'form' ? 'text-blue-600 bg-blue-50 font-black shadow-inner border border-blue-100' : 'text-gray-300 font-bold active:scale-95'}`}><Plus size={24} /><span className="text-[9px] uppercase tracking-widest font-black">Saisie</span></button>
                    <button onClick={() => {setView('dashboard'); setSubmitted(false)}} className={`flex flex-col items-center gap-1.5 py-2 px-6 rounded-2xl transition-all ${view === 'dashboard' ? 'text-blue-600 bg-blue-50 font-black shadow-inner border border-blue-100' : 'text-gray-300 font-bold active:scale-95'}`}><LayoutDashboard size={24} /><span className="text-[9px] uppercase tracking-widest font-black">Historique</span></button>
                    <button onClick={() => {setView('salary'); setSubmitted(false)}} className={`flex flex-col items-center gap-1.5 py-2 px-6 rounded-2xl transition-all ${view === 'salary' ? 'text-blue-600 bg-blue-50 font-black shadow-inner border border-blue-100' : 'text-gray-300 font-bold active:scale-95'}`}><Coins size={24} /><span className="text-[9px] uppercase tracking-widest font-black">Salaire</span></button>
                </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

